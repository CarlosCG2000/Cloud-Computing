
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://migue.github.io/play-aws/automated/packer/">
      
      
        <link rel="prev" href="../intro/">
      
      
        <link rel="next" href="../terraform/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Building the image - PlayFramework and AWS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#image-creation-with-packer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PlayFramework and AWS" class="md-header__button md-logo" aria-label="PlayFramework and AWS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PlayFramework and AWS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building the image
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PlayFramework and AWS" class="md-nav__button md-logo" aria-label="PlayFramework and AWS" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PlayFramework and AWS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Local development
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Local development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../local/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../local/running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running the app
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Manual deployment
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Manual deployment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/instance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating the instance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/deploy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying our application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../manual/running/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running our application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Production database
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Production database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/local-mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Local MySQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/dependencies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dependencies
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/rds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS RDS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../database/connecting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connecting to RDS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Scaling and fault-tolerance
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Scaling and fault-tolerance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scaling/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scaling/ami/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a snapshot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scaling/loadbalancing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load balancing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Infrastructure as Code
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Infrastructure as Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iac/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iac/why/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Why?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iac/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../iac/benefits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Benefits
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Automated deployment
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Automated deployment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Building the image
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Building the image
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing-packer" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Packer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Packer script
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Packer script
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Packer script">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      Required plugins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-build-section" class="md-nav__link">
    <span class="md-ellipsis">
      The build section
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-the-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Executing the Packer script
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../terraform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying the image
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About me
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing-packer" class="md-nav__link">
    <span class="md-ellipsis">
      Installing Packer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Packer script
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Packer script
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Packer script">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      Required plugins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-build-section" class="md-nav__link">
    <span class="md-ellipsis">
      The build section
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-the-packer-script" class="md-nav__link">
    <span class="md-ellipsis">
      Executing the Packer script
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="image-creation-with-packer">Image creation with Packer</h1>
<p>The first we need to do to automate our infrastructure is to create a base image. This image will be used to create new servers, and it will contain all the necessary software and configurations to run our application. We will basically replicate the manual process we did in the previous chapter, but in an automated way.</p>
<h2 id="installing-packer">Installing Packer</h2>
<p>You can find here how to install Packer in your OS: <a href="https://developer.hashicorp.com/packer/tutorials/docker-get-started/get-started-install-cli">Install Packer</a></p>
<h2 id="creating-a-packer-script">Creating a Packer script</h2>
<p>Packer scripts are written in HCL (https://github.com/hashicorp/hcl). Let's start backwards, defining a fully functional Packer script and then explaining each part.</p>
<div class="highlight"><pre><span></span><code><span class="nb">packer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">amazon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;github.com/hashicorp/amazon&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;aws_access_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;aws_secret_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;agenda_version&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0-SNAPSHOT&quot;</span>
<span class="p">}</span>

<span class="err">source</span><span class="w"> </span><span class="s2">&quot;amazon-ebs&quot; &quot;ubuntu-agenda&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">access_key</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_access_key</span>
<span class="w">  </span><span class="na">secret_key</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_secret_key</span>
<span class="w">  </span><span class="na">region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eu-south-2&quot;</span>
<span class="w">  </span><span class="na">source_ami</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ami-01d67cc599f23990b&quot;</span>
<span class="w">  </span><span class="na">instance_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;t3.micro&quot;</span>
<span class="w">  </span><span class="na">ssh_username</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<span class="w">  </span><span class="na">ami_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;agenda-app-${var.agenda_version}&quot;</span>
<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.agenda_version}&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>


<span class="nb">build</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;source.amazon-ebs.ubuntu-agenda&quot;</span><span class="p">]</span>

<span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;file&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;agenda.service&quot;</span>
<span class="w">    </span><span class="na">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;file&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../target/universal/agenda-${var.agenda_version}.zip&quot;</span>
<span class="w">    </span><span class="na">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/agenda.zip&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;shell&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;sleep 30&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo apt-get update&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo apt install -y openjdk-17-jdk-headless unzip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;unzip /home/ubuntu/agenda.zip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo mv /home/ubuntu/agenda-${var.agenda_version} /home/ubuntu/agenda&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo cp /home/ubuntu/agenda.service /etc/systemd/system&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo systemctl daemon-reload&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo systemctl enable agenda.service&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="understanding-the-packer-script">Understanding the Packer script</h2>
<p>THe Packer script is divided into three main sections: <code>packer</code>, <code>variables</code>, and <code>build</code>.</p>
<h3 id="required-plugins">Required plugins</h3>
<p>The first bits of the script with the <code>packer</code> section and the <code>variable</code> areis used to define the required plugins for the script. In this case, we are using the <code>amazon</code> plugin since we are going to create an AMI in AWS.</p>
<div class="highlight"><pre><span></span><code><span class="nb">packer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">amazon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;github.com/hashicorp/amazon&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 1.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;aws_access_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;aws_secret_key&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="p">}</span>

<span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;agenda_version&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.0-SNAPSHOT&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="the-build-section">The build section</h3>
<p>In the build section we find two main parts: the <code>source</code> and the <code>provisioners</code>. The former defines the source of the image we are going to use to create the new image. In this case, we are using an Ubuntu image from AWS.</p>
<div class="highlight"><pre><span></span><code><span class="err">source</span><span class="w"> </span><span class="s2">&quot;amazon-ebs&quot; &quot;ubuntu-agenda&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">access_key</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_access_key</span>
<span class="w">  </span><span class="na">secret_key</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_secret_key</span>
<span class="w">  </span><span class="na">region</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;eu-south-2&quot;</span>
<span class="w">  </span><span class="na">source_ami</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ami-01d67cc599f23990b&quot;</span>
<span class="w">  </span><span class="na">instance_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;t3.micro&quot;</span>
<span class="w">  </span><span class="na">ssh_username</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ubuntu&quot;</span>
<span class="w">  </span><span class="na">ami_name</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;agenda-app-${var.agenda_version}&quot;</span>
<span class="w">  </span><span class="nb">tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.agenda_version}&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>provisioners</code> section defines the steps we need to follow to configure the image. In this case, we are copying a service file and the application zip file to the server, installing Java, unzipping the application, and configuring the service to start at boot.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;file&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;agenda.service&quot;</span>
<span class="w">    </span><span class="na">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;file&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">source</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../target/universal/agenda-${var.agenda_version}.zip&quot;</span>
<span class="w">    </span><span class="na">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/home/ubuntu/agenda.zip&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kr">provisioner</span><span class="w"> </span><span class="nv">&quot;shell&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;sleep 30&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo apt-get update&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo apt install -y openjdk-17-jdk-headless unzip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;unzip /home/ubuntu/agenda.zip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo mv /home/ubuntu/agenda-${var.agenda_version} /home/ubuntu/agenda&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo cp /home/ubuntu/agenda.service /etc/systemd/system&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo systemctl daemon-reload&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;sudo systemctl enable agenda.service&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>Packer has a lot of provisioners that can be used to configure the image. Setting up our application is relatively simple, so the <code>shell</code> and <code>file</code> provisioners are enough.</p>
<h2 id="executing-the-packer-script">Executing the Packer script</h2>
<p>The first thing we need to do is to init the Packer script. From the deploy <code>folder</code>, run:</p>
<div class="highlight"><pre><span></span><code>packer<span class="w"> </span>init<span class="w"> </span>.
</code></pre></div>
<p>It will download the necessary plugins to run the script.</p>
<p>The script provided has been already formatted, but, if you need it, you can run:</p>
<div class="highlight"><pre><span></span><code>packer<span class="w"> </span>fmt<span class="w"> </span>.
</code></pre></div>
<p>that will format the script for readability and consistency. Packer will print out the names of the files it modified, if any.</p>
<p>Before executing the script, you can validate it with:</p>
<div class="highlight"><pre><span></span><code>packer<span class="w"> </span>validate<span class="w"> </span>.
</code></pre></div>
<p>Before we actually run the build process, note that we need to provide the AWS credentials to Packer. You can do it by setting the environment variables:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>your_access_key
<span class="nb">export</span><span class="w"> </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>your_secret_key
</code></pre></div>
<p>Now, you can finally build your AMI:</p>
<div class="highlight"><pre><span></span><code>packer<span class="w"> </span>build<span class="w"> </span>agenda.pkr.hcl
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>